<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å³æœŸç‰©è³‡è­¦ç¤º</title>
  <style>
    body { font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; padding: 20px; line-height: 1.6; background-color: #f8fafc; max-width: 600px; margin: auto; }
    h1 { color: #d32f2f; text-align: center; margin-bottom: 25px; font-weight: 800; }
    
    .warning-item { 
      background: white; border: 1px solid #feb2b2; border-left: 6px solid #e53e3e; 
      margin-bottom: 15px; padding: 15px; border-radius: 12px; 
      box-shadow: 0 4px 6px rgba(0,0,0,0.05); 
      display: flex; align-items: center; gap: 15px;
    }

    /* ğŸš€ ä¾›åƒ§ç‰¹æ®Šæ¨£å¼ */
    .sangha-item { border-left-color: #f59e0b; background-color: #fffbeb; border-color: #fde68a; }
    .sangha-tag { background: #fef3c7; color: #92400e; padding: 2px 8px; border-radius: 4px; font-size: 0.75em; font-weight: bold; border: 1px solid #fde68a; margin-left: 5px; }

    .thumb-img { width: 75px; height: 75px; border-radius: 8px; object-fit: cover; border: 1px solid #eee; cursor: zoom-in; flex-shrink: 0; }
    .no-img { width: 75px; height: 75px; border-radius: 8px; background: #fff5f5; color: #feb2b2; display: flex; align-items: center; justify-content: center; font-size: 24px; flex-shrink: 0; }

    .content-box { flex-grow: 1; }
    .expiry-date { color: #e53e3e; font-weight: bold; margin-top: 5px; font-size: 1em; }
    .cat { color: #718096; font-size: 0.8em; font-weight: bold; }
    .location-tag { color: #4a5568; font-size: 0.85em; margin-top: 4px; display: block; }
    
    .qty-box { background: rgba(229, 62, 62, 0.05); padding: 8px 12px; border-radius: 6px; margin-top: 8px; border: 1px dashed #feb2b2; font-size: 0.9em; }
    .sangha-item .qty-box { background: rgba(245, 158, 11, 0.05); border-color: #fde68a; }

    .skeleton { background: linear-gradient(110deg, #ececec 8%, #f5f5f5 18%, #ececec 33%); background-size: 200% 100%; animation: shine 1.5s linear infinite; height: 120px; border-radius: 10px; margin-bottom: 15px; }
    @keyframes shine { to { background-position-x: -200%; } }

    #image-modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); align-items: center; justify-content: center; flex-direction: column; }
    #modal-img { max-width: 90%; max-height: 80%; border-radius: 8px; border: 4px solid white; }
    
    hr { border: 0; border-top: 1px solid #e2e8f0; margin: 30px 0; }
    #back-home { display: inline-block; text-decoration: none; color: #2196F3; font-weight: bold; }
    .empty-msg { text-align: center; padding: 50px; color: #718096; }
  </style>
</head>
<body>
  <h1>â° å³æœŸç‰©è³‡æé†’</h1>
  <p style="text-align:center; font-size:0.8em; color:#94a3b8; margin-top:-15px;">( åƒ…é¡¯ç¤º 7 å¤©å…§åˆ°æœŸä¸”å°šæœªéæœŸä¹‹ç‰©è³‡ )</p>

  <div id="list">
    <div class="skeleton"></div>
    <div class="skeleton"></div>
  </div>

  <div id="image-modal" onclick="this.style.display='none'">
    <img id="modal-img" src="">
    <p style="color:white; margin-top:15px;">(é»æ“Šä»»ä½•è™•é—œé–‰)</p>
  </div>

  <hr/>
  <div style="text-align:center;">
    <a id="back-home" href="#">â¬…ï¸ å›é¦–é </a>
  </div>

  <script>
    function loadExpiryData() {
      // ğŸš€ å‚³å…¥ trueï¼Œç¢ºä¿ç²å–åŒ…å«ä¾›åƒ§çš„æ‰€æœ‰å³æœŸæ•¸æ“š
      google.script.run.withSuccessHandler(res => {
        const container = document.getElementById('list');
        if (!res || !res.success) {
          container.innerHTML = `<div style="color:red; text-align:center;">âŒ è¼‰å…¥å¤±æ•—</div>`;
          return;
        }

        const today = new Date();
        today.setHours(0, 0, 0, 0);

        container.innerHTML = ''; 
        
        // ğŸš€ é‚è¼¯ä¿®æ”¹ï¼šéæ¿¾æ‰å·²ç¶“éæœŸçš„ç‰©è³‡ (æ•ˆæœŸ < ä»Šå¤©)
        const validList = (res.expiry || []).filter(d => {
          const expDate = new Date(d.expiryDate);
          expDate.setHours(0, 0, 0, 0);
          return expDate >= today; 
        });

        if (validList.length === 0) {
          container.innerHTML = '<div class="empty-msg">ğŸ‰ <strong>ç›®å‰æ²’æœ‰å³å°‡åˆ°æœŸçš„ç‰©è³‡ã€‚</strong></div>';
          return;
        }

        validList.forEach(d => {
          const isSangha = d.stockStatus === 'ä¾›åƒ§';
          const expDate = new Date(d.expiryDate);
          expDate.setHours(0, 0, 0, 0);
          
          // è¨ˆç®—å‰©é¤˜å¤©æ•¸
          const diffDays = Math.ceil((expDate - today) / (1000 * 60 * 60 * 24));

          const div = document.createElement('div');
          div.className = 'warning-item' + (isSangha ? ' sangha-item' : '');
          
          const imgHtml = d.photoUrl ? 
            `<img src="${d.photoUrl}" class="thumb-img" onclick="zoomImg('${d.photoUrl}')">` : 
            `<div class="no-img">${isSangha ? 'â˜¸ï¸' : 'â°'}</div>`;

          div.innerHTML = `
            ${imgHtml}
            <div class="content-box">
              <div>
                <span class="cat">[${d.category}]</span> 
                ${isSangha ? '<span class="sangha-tag">ä¾›åƒ§</span>' : ''}
                <br><strong>${d.itemName}</strong> ${(d.color && d.color !== 'ç„¡') ? `(${d.color})` : ''}
              </div>
              <span class="location-tag">ğŸ“ å­˜æ”¾ä½ç½®ï¼š${d.location || 'æœªæ¨™è¨»'}</span>
              <div class="qty-box">
                <span style="color:#2d3748; font-weight:bold;">ç›®å‰å‰©é¤˜ï¼š${d.quantity} ${d.unit}</span>
              </div>
              <div class="expiry-date">
                âš ï¸ ${diffDays === 0 ? 'ä»Šå¤©è¦éæœŸäº†ï¼' : 'é‚„å‰© ' + diffDays + ' å¤©åˆ°æœŸ'}
              </div>
              <div style="font-size:0.75em; color:#94a3b8;">æ•ˆæœŸè‡³ï¼š${d.expiryDate}</div>
            </div>
          `;
          container.appendChild(div);
        });
      }).getSummaryData(true); 
    }

    function zoomImg(src) {
      const modal = document.getElementById('image-modal');
      const modalImg = document.getElementById('modal-img');
      modalImg.src = src;
      modal.style.display = 'flex';
    }

    loadExpiryData();

    google.script.run.withSuccessHandler(url => {
      const a = document.getElementById('back-home');
      a.href = url + "?page=index";
      a.target = "_top";
    }).getScriptUrl();
  </script>
</body>
</html>
