<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>å›ºå®šè³‡ç”¢å»ºæª” - æ•ˆèƒ½å„ªåŒ–ç‰ˆ</title>
  <style>
    body { font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; padding: 20px; margin: auto; line-height: 1.6; background-color: #f0f2f5; color: #333; }
    h1 { color: #1976D2; text-align: center; margin-bottom: 20px; }
    
    form { 
      background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      max-width: 800px; margin: auto; transition: all 0.3s ease;
    }

    @keyframes success-pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.01); background: #f0fff4; }
      100% { transform: scale(1); }
    }
    .form-success { animation: success-pulse 0.4s ease-out; }

    label { display: block; margin-top: 15px; font-weight: bold; color: #4a5568; font-size: 0.95em; }
    input, select { width: 100%; padding: 12px; margin: 8px 0; box-sizing: border-box; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 16px; outline: none; }
    input:focus { border-color: #2196F3; box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1); }

    .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 18px; height: 18px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; margin-right: 8px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    @media (min-width: 600px) {
      #asset-form { display: grid; grid-template-columns: 1fr 1fr; gap: 0 20px; }
      h1, .full-width, button, #msg, .photo-area { grid-column: span 2; }
    }

    button { width: 100%; padding: 15px; background: #2196F3; color: white; border: none; cursor: pointer; font-size: 18px; border-radius: 8px; font-weight: bold; margin-top: 25px; transition: background 0.2s; }
    button:hover { background: #1976D2; }
    button:disabled { background: #cbd5e0; cursor: not-allowed; }

    #msg { margin-top: 20px; text-align: center; padding: 12px; border-radius: 8px; font-weight: bold; min-height: 1.5em; display: none; }
    .nav-box { margin-top: 30px; text-align: center; }
    a { color: #2196F3; text-decoration: none; font-weight: bold; }
    .important-label { color: #e53e3e; }

    /* ğŸ“¸ ç…§ç‰‡å€åŸŸæ¨£å¼ */
    .photo-area { background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px dashed #cbd5e0; margin-top: 15px; text-align: center; }
    #previewImg { max-width: 120px; max-height: 120px; border-radius: 6px; margin-top: 10px; display: none; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
  </style>
</head>
<body>
  <h1>ğŸ› ï¸ å›ºå®šè³‡ç”¢å»ºæª”å…¥åº«</h1>
  
  <form id="asset-form">
    <label>ä¾†æºé¡åˆ¥ï¼š</label>
    <select name="sourceType">
      <option value="æ—¢æœ‰è³‡ç”¢">æ—¢æœ‰è³‡ç”¢ (ç›¤é»å…¥åº«)</option>
      <option value="ä¸­å°ç”³è«‹">ä¸­å°ç”³è«‹ (æ’¥ç™¼)</option>
      <option value="æ¡è³¼">æ¡è³¼å…¥åº«</option>
    </select>
    
    <label>ç‰©å“åç¨±ï¼š</label>
    <input type="text" name="itemName" required placeholder="ä¾‹å¦‚ï¼šå…«åˆç¶“ã€æŠ•å½±æ©Ÿ">
    
    <div>
      <label>é¡è‰²è¦æ ¼ï¼š</label>
      <input type="text" name="color" placeholder="ä¾‹å¦‚ï¼šå’–å•¡é»ƒã€é»‘è‰²">
    </div>

    <div>
      <label>å–®ä½ï¼š</label>
      <input type="text" name="unit" placeholder="ä¾‹å¦‚ï¼šæœ¬ã€å°ã€å€‹">
    </div>
    
    <label>è¦æ ¼å‹è™Ÿï¼š</label>
    <input type="text" name="spec" placeholder="ä¾‹å¦‚ï¼šå‹è™Ÿæˆ–å°ºå¯¸">
    
    <label>å­˜æ”¾ä½ç½®ï¼š</label>
    <input type="text" name="location" placeholder="ä¾‹å¦‚ï¼š1æ¨“å¤§é›„å¯¶æ®¿å‰æ–¹æ«ƒå­">
    
    <label>ä¿ç®¡äººï¼š</label>
    <input type="text" name="keeper" placeholder="è¼¸å…¥ç›®å‰è² è²¬ä¿ç®¡çš„äººå“¡">
    
    <label class="important-label">å»ºæª”æ•¸é‡ (æ‰¹æ¬¡)ï¼š</label>
    <input type="number" name="assetQty" value="1" min="1" max="100" required>

    <div class="photo-area">
      <label style="margin-top:0; color:#1976D2;">ğŸ“¸ è³‡ç”¢å¤–è§€æ‹ç…§ (é¸å¡«ï¼Œç›´æ¥å­˜å…¥è¡¨æ ¼)ï¼š</label>
      <input type="file" id="cameraInput" accept="image/*" capture="environment">
      <img id="previewImg" src="">
      <p id="photoStatus" style="font-size: 0.75em; color: #a0aec0; margin-top: 5px;">è‹¥ç‚ºæ‰¹æ¬¡å»ºæª”ï¼Œæ‰€æœ‰ç·¨è™Ÿå°‡å…±ç”¨æ­¤ç…§ç‰‡</p>
      <input type="hidden" name="photoUrl" id="hiddenPhotoUrl">
    </div>
    
    <label class="full-width">å‚™è¨»ï¼š</label>
    <input type="text" name="note" class="full-width" placeholder="ä¾‹å¦‚ï¼š2026å¹´åº¦ç›¤é»å…¥åº«">

    <button type="submit" id="submit-btn">ç¢ºèªé€å‡ºä¸¦ç”Ÿæˆç·¨è™Ÿ</button>
  </form>

  <div id="msg"></div>
  <div class="nav-box"><a id="home" href="#">â¬…ï¸ å›é¦–é </a></div>

  <script>
    const form = document.getElementById('asset-form');
    const btn = document.getElementById('submit-btn');
    const msg = document.getElementById('msg');
    const cameraInput = document.getElementById('cameraInput');
    const previewImg = document.getElementById('previewImg');
    const hiddenPhotoUrl = document.getElementById('hiddenPhotoUrl');
    const photoStatus = document.getElementById('photoStatus');

    // é è¼‰å…¥ URL
    google.script.run.withSuccessHandler(url => {
      document.getElementById('home').href = url + "?page=index";
    }).getScriptUrl();

    // --- ğŸš€ ç…§ç‰‡å£“ç¸®é‚è¼¯ ---
    cameraInput.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) {
        hiddenPhotoUrl.value = "";
        previewImg.style.display = 'none';
        return;
      }

      photoStatus.textContent = "â³ ç¸®åœ–è™•ç†ä¸­...";
      const reader = new FileReader();
      reader.onload = function(event) {
        const img = new Image();
        img.onload = function() {
          const canvas = document.createElement('canvas');
          const max_size = 120; // è³‡ç”¢ç¸®åœ– 120px è¶³å¤ è¾¨è­˜
          let width = img.width;
          let height = img.height;
          if (width > height) {
            if (width > max_size) { height *= max_size / width; width = max_size; }
          } else {
            if (height > max_size) { width *= max_size / height; height = max_size; }
          }
          canvas.width = width;
          canvas.height = height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);
          const dataUrl = canvas.toDataURL('image/jpeg', 0.5); 
          previewImg.src = dataUrl;
          previewImg.style.display = 'inline-block';
          hiddenPhotoUrl.value = dataUrl;
          photoStatus.textContent = "âœ… ç…§ç‰‡å·²å‚™å¦¥";
        };
        img.src = event.target.result;
      };
      reader.readAsDataURL(file);
    });

    form.addEventListener('submit', function(e) {
      e.preventDefault();
      btn.disabled = true;
      btn.innerHTML = '<div class="loader"></div> â³ å‚³é€ä¸­...';
      msg.style.display = "block";
      msg.style.background = "#e3f2fd";
      msg.innerHTML = "æ­£åœ¨åŸ·è¡Œæ‰¹æ¬¡ç·¨è™Ÿå»ºæª”èˆ‡å¯«å…¥...";

      const formData = Object.fromEntries(new FormData(this));

      google.script.run
        .withSuccessHandler(res => {
          btn.disabled = false;
          btn.textContent = "ç¢ºèªé€å‡ºä¸¦ç”Ÿæˆç·¨è™Ÿ";
          if(res.success) {
            form.classList.add('form-success');
            setTimeout(() => form.classList.remove('form-success'), 500);
            msg.style.background = "#d4edda";
            msg.style.color = "#155724";
            msg.innerHTML = `âœ… <b>å»ºæª”æˆåŠŸï¼</b><br>ç·¨è™Ÿï¼š${res.assetId}`;
            
            const stickyData = {
              sourceType: formData.sourceType,
              location: formData.location,
              keeper: formData.keeper,
              unit: formData.unit
            };
            form.reset();
            form.sourceType.value = stickyData.sourceType;
            form.location.value = stickyData.location;
            form.keeper.value = stickyData.keeper;
            form.unit.value = stickyData.unit;
            
            // é‡ç½®ç…§ç‰‡å€
            previewImg.style.display = 'none';
            hiddenPhotoUrl.value = "";
            photoStatus.textContent = "è‹¥ç‚ºæ‰¹æ¬¡å»ºæª”ï¼Œæ‰€æœ‰ç·¨è™Ÿå°‡å…±ç”¨æ­¤ç…§ç‰‡";
            
            form.itemName.focus();
          } else {
            msg.style.background = "#f8d7da";
            msg.style.color = "#721c24";
            msg.textContent = "âŒ å¤±æ•—ï¼š" + res.message;
          }
        })
        .withFailureHandler(err => {
          btn.disabled = false;
          btn.textContent = "ç¢ºèªé€å‡ºä¸¦ç”Ÿæˆç·¨è™Ÿ";
          msg.style.background = "#f8d7da";
          msg.textContent = "âš ï¸ é€šè¨ŠéŒ¯èª¤ï¼š" + err;
        })
        .importAsset(formData);
    });
  </script>
</body>
</html>
