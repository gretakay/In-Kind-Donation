<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸ“¤ ç‰©è³‡é ˜ç”¨ç³»çµ± (å°æ¯”å¼·åŒ–ç©©å®šç‰ˆ)</title>
  <style>
    :root { --primary: #1d4ed8; --success: #059669; --danger: #dc2626; --bg: #f8fafc; --text-main: #0f172a; --text-muted: #475569; }
    body { font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; padding: 15px; max-width: 650px; margin: auto; background-color: var(--bg); color: var(--text-main); line-height: 1.5; }
    
    .card { background: white; padding: 22px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); margin-bottom: 15px; border: 1px solid #e2e8f0; }
    h1 { font-size: 1.5rem; text-align: center; margin-bottom: 20px; font-weight: 800; color: #1e293b; }

    label { font-weight: 800; color: var(--text-muted); font-size: 0.9em; display: block; margin-bottom: 6px; }
    input, select { width: 100%; padding: 12px; border: 1px solid #cbd5e0; border-radius: 10px; font-size: 16px; outline: none; margin-bottom: 12px; color: var(--text-main); font-weight: 500; }
    
    .search-input { border: 2px solid #3b82f6 !important; background: #eff6ff; font-weight: 800; }

    /* ğŸš€ åœ–ç‰‡èˆ‡è³‡è¨Šé è¦½å€ - å°æ¯”å¼·åŒ– */
    #info { display: none; background: #f0f9ff; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #bae6fd; align-items: center; }
    .preview-img { width: 75px; height: 75px; border-radius: 10px; object-fit: cover; margin-right: 15px; border: 2px solid #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); flex-shrink: 0; }
    .info-detail b { color: var(--primary); font-size: 1.15rem; }

    /* ğŸš€ æ¸…å–®æ–‡å­—é¡è‰²å¼·åŒ– */
    .cart-row { display: flex; justify-content: space-between; align-items: center; padding: 14px; background: #fff; border: 2px solid #e2e8f0; border-radius: 12px; margin-bottom: 10px; }
    .cart-text { color: var(--text-main); font-size: 1.1rem; font-weight: 900; flex-grow: 1; }
    .cart-text b { color: var(--primary); font-size: 1.2rem; margin-left: 4px; }
    .btn-del { color: var(--danger); border: 2px solid #fee2e2; background: #fff; font-weight: 900; cursor: pointer; padding: 8px 15px; border-radius: 10px; transition: 0.2s; }
    .btn-del:hover { background: #fef2f2; border-color: var(--danger); }

    .btn-main { width: 100%; padding: 16px; border-radius: 12px; border: none; font-weight: 900; cursor: pointer; transition: 0.2s; font-size: 1.15rem; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .btn-blue { background: #2563eb; color: white; margin-bottom: 12px; box-shadow: 0 4px 10px rgba(37, 99, 235, 0.3); }
    .btn-green { background: var(--success); color: white; box-shadow: 0 4px 10px rgba(5, 150, 105, 0.3); }

    #confirmBox { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15,23,42,0.95); z-index: 1000; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(4px); }
    .modal { background: white; width: 100%; max-width: 420px; padding: 30px; border-radius: 24px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); }
    
    .loader { border: 3.5px solid #f3f3f3; border-top: 3.5px solid white; border-radius: 50%; width: 22px; height: 22px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <h1>ğŸ“¤ ç‰©è³‡é ˜ç”¨ / å€Ÿå‡º</h1>

  <div class="card">
    <label>1. é ˜ç”¨æ¨¡å¼</label>
    <select id="mode" onchange="resetView()">
      <option value="consumable">ğŸ“¦ ä¸€èˆ¬ç‰©è³‡ (æ¶ˆè€—å“)</option>
      <option value="asset">ğŸ› ï¸ å›ºå®šè³‡ç”¢ (éœ€å›æ”¶)</option>
    </select>

    <div id="sanghaBox" style="background:#fff7ed; padding:12px; border-radius:10px; display:flex; align-items:center; gap:10px; margin-bottom:15px; border:1px solid #fed7aa;">
      <input type="checkbox" id="sanghaToggle" style="width:24px; height:24px;" onchange="loadData()">
      <label for="sanghaToggle" style="margin:0; color:#c2410c; cursor:pointer; font-weight:900; font-size:1.1rem;">ğŸ”“ é¡¯ç¤ºä¸¦å…è¨±é ˜ç”¨ã€Œä¾›åƒ§ã€ç‰©è³‡</label>
    </div>

    <label>2. æœå°‹èˆ‡é¸æ“‡ç‰©å“</label>
    <input type="text" id="search" class="search-input" placeholder="è¼¸å…¥é—œéµå­—..." oninput="renderSelect()">
    <select id="itemSelect" onchange="showInfo()">
      <option value="">-- è¼‰å…¥æ•¸æ“šä¸­ --</option>
    </select>

    <div id="info"></div>

    <label>3. æ•¸é‡</label>
    <input type="number" id="qty" value="1" min="1">

    <button class="btn-main btn-blue" onclick="add()">â• åŠ å…¥å¾…é ˜æ¸…å–®</button>
  </div>

  <div class="card" id="cartArea">
    <label style="color:#0f172a; font-size:1.1rem;">ğŸ“‹ å¾…è™•ç†æ¸…å–®</label>
    <div id="cartList" style="text-align:center; color:#64748b; padding:20px; font-weight:700; font-size:1.1rem;">ç›®å‰æ²’æœ‰ä»»ä½•ç‰©å“</div>
    <button id="submitBtn" class="btn-main btn-green" style="margin-top:15px; display:none;" onclick="confirmAll()">âœ… ç¢ºèªç„¡èª¤ï¼Œé€²è¡Œæœ€å¾Œæ ¸å°</button>
  </div>

  <div id="confirmBox">
    <div class="modal">
      <h2 style="margin-top:0; text-align:center; color:#0f172a; font-weight:900;">ğŸ“ æœ€çµ‚é ˜ç”¨ç¢ºèª</h2>
      <div id="summary" style="margin-bottom:20px; background:#f8fafc; padding:15px; border-radius:12px; border:2px solid #e2e8f0; font-weight:800; font-size:1.1rem;"></div>
      
      <label>é ˜ç”¨/å€Ÿç”¨äºº (å–®ä½æˆ–å§“å)</label>
      <input type="text" id="receiver" placeholder="è«‹å¡«å¯«å°è±¡">
      
      <div id="assetFields" style="display:none;">
        <label>é è¨ˆæ­¸é‚„æ—¥</label>
        <input type="date" id="rDate">
      </div>

      <label>ç¶“æ‰‹äºº (é»æ”¶è€…)</label>
      <input type="text" id="handler" placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å">

      <div style="display:flex; gap:12px; margin-top:25px;">
        <button onclick="document.getElementById('confirmBox').style.display='none'" style="flex:1; padding:14px; border-radius:12px; border:2px solid #cbd5e0; background:white; font-weight:900; cursor:pointer;">å–æ¶ˆ</button>
        <button id="goBtn" onclick="submit()" style="flex:2; padding:14px; border-radius:12px; background:var(--success); color:white; border:none; font-weight:900; cursor:pointer;">ç¢ºèªé€å‡ºç´€éŒ„</button>
      </div>
    </div>
  </div>

  <div style="text-align:center; padding-bottom:30px;"><a href="#" id="homeLink" style="color:#1d4ed8; font-weight:900; text-decoration:none; font-size:1.1rem; border-bottom:2px solid #bfdbfe;">â¬…ï¸ è¿”å›ä¸»é¸å–®</a></div>

  <script>
    let inv = [], assets = [], cart = [];
    
    function loadData() {
      const isSangha = document.getElementById('sanghaToggle').checked;
      google.script.run.withSuccessHandler(res => {
        const today = new Date().setHours(0,0,0,0);
        inv = res.inventory.filter(i => !i.expiryDate || new Date(i.expiryDate) >= today);
        assets = res.assets;
        renderSelect();
      }).getSummaryData(isSangha);
    }

    function renderSelect() {
      const mode = document.getElementById('mode').value;
      const key = document.getElementById('search').value.toLowerCase();
      const sel = document.getElementById('itemSelect');
      sel.innerHTML = '<option value="">-- è«‹é¸æ“‡ç‰©å“ --</option>';
      const data = (mode === 'consumable' ? inv : assets);
      data.filter(i => i.name.toLowerCase().includes(key)).forEach(i => {
        const name = i.color && i.color !== 'ç„¡' ? `${i.name} (${i.color})` : i.name;
        const tag = i.isSangha ? ' [ä¾›åƒ§]' : '';
        const qty = (mode === 'consumable' ? i.qty : i.inStock);
        sel.add(new Option(`${name}${tag} (é¤˜:${qty})`, name));
      });
    }

    function showInfo() {
      const mode = document.getElementById('mode').value;
      const name = document.getElementById('itemSelect').value;
      const infoDiv = document.getElementById('info');
      const data = (mode === 'consumable' ? inv : assets);
      const i = data.find(x => (x.color && x.color !== 'ç„¡' ? `${x.name} (${x.color})` : x.name) === name);
      
      if (i) {
        infoDiv.style.display = 'flex';
        const imgHtml = i.photoUrl ? 
          `<img src="${i.photoUrl}" class="preview-img">` : 
          `<div class="preview-img" style="background:#e2e8f0; display:flex; align-items:center; justify-content:center; color:#64748b; font-size:28px;">ğŸ“¦</div>`;
        
        infoDiv.innerHTML = `${imgHtml}<div><div style="font-size:0.9rem; color:var(--text-muted); font-weight:800;">ğŸ“ ${i.location || 'åº«æˆ¿'}</div><b style="color:var(--primary); font-size:1.2rem;">ç›®å‰åº«å­˜ï¼š${(mode === 'consumable' ? i.qty : i.inStock)}</b></div>`;
        
        // ğŸš€ é—œéµä¿®æ”¹ï¼šæ›´æ›ç‰©å“æ™‚ï¼Œæ•¸é‡è‡ªå‹•é‡ç½®ç‚º 1
        document.getElementById('qty').value = 1;
      } else {
        infoDiv.style.display = 'none';
      }
    }

    function add() {
      const sel = document.getElementById('itemSelect');
      const qty = parseInt(document.getElementById('qty').value);
      if (!sel.value || isNaN(qty) || qty <= 0) return alert("âš ï¸ è«‹å…ˆé¸æ“‡ç‰©å“ä¸¦è¼¸å…¥æ­£ç¢ºæ•¸é‡");

      const mode = document.getElementById('mode').value;
      const data = (mode === 'consumable' ? inv : assets);
      const item = data.find(x => (x.color && x.color !== 'ç„¡' ? `${x.name} (${x.color})` : x.name) === sel.value);
      const limit = (mode === 'consumable' ? item.qty : item.inStock);

      const existing = cart.find(c => c.name === sel.value);
      const totalInCart = (existing ? existing.qty : 0) + qty;

      // ğŸš€ é—œéµæ””æˆªï¼šæª¢æŸ¥ç¸½é ˜ç”¨é‡æ˜¯å¦å¤§æ–¼åº«å­˜
      if (totalInCart > limit) {
        return alert(`âŒ åº«å­˜ä¸è¶³ï¼ç„¡æ³•åŠ å…¥æ¸…å–®ã€‚\n\nç‰©å“ï¼š${sel.value}\nç›®å‰é¤˜é¡ï¼š${limit}\nå·²åœ¨æ¸…å–®ï¼š${existing ? existing.qty : 0}\næ¬²åŠ æ•¸é‡ï¼š${qty}\n\nè«‹ä¿®æ­£æ•¸é‡ã€‚`);
      }

      if (existing) {
        existing.qty += qty;
      } else {
        cart.push({ name: sel.value, qty: qty, isSangha: sel.options[sel.selectedIndex].text.includes('[ä¾›åƒ§]') });
      }
      renderCart();
    }

    function renderCart() {
      const list = document.getElementById('cartList');
      const sub = document.getElementById('submitBtn');
      if (!cart.length) { list.innerHTML = 'ç›®å‰æ²’æœ‰ä»»ä½•ç‰©å“'; sub.style.display='none'; return; }
      sub.style.display='block';
      // ğŸš€ å¼·åŒ–å°æ¯”èˆ‡å­—é«”
      list.innerHTML = cart.map((c, i) => `
        <div class="cart-row">
          <span class="cart-text">${c.isSangha?'<span style="color:#c2410c;">â˜¸ï¸ [ä¾›åƒ§]</span>':''} ${c.name} <b>x ${c.qty}</b></span>
          <button class="btn-del" onclick="cart.splice(${i},1);renderCart()">ç§»é™¤</button>
        </div>
      `).join('');
    }

    function confirmAll() {
      const mode = document.getElementById('mode').value;
      document.getElementById('assetFields').style.display = (mode === 'asset' ? 'block' : 'none');
      document.getElementById('summary').innerHTML = cart.map(c => `<div style="padding:6px 0; border-bottom:1px solid #f1f5f9;">â— ${c.name} <span style="color:var(--primary);">x ${c.qty}</span></div>`).join('');
      document.getElementById('confirmBox').style.display = 'flex';
    }

    async function submit() {
      const receiver = document.getElementById('receiver').value;
      const handler = document.getElementById('handler').value;
      if (!receiver || !handler) return alert("âš ï¸ è«‹å¡«å¯«é ˜ç”¨äººèˆ‡ç¶“æ‰‹äººå§“å");
      
      const btn = document.getElementById('goBtn');
      btn.disabled = true; btn.innerHTML = '<div class="loader"></div> æ­£åœ¨é€£ç·šå¯«å…¥...';

      const mode = document.getElementById('mode').value;
      const returnDate = document.getElementById('rDate').value;

      try {
        // ä½¿ç”¨ Promise.all åŒæ­¥ç™¼é€å¤šç­†å¯«å…¥è«‹æ±‚
        const tasks = cart.map(item => {
          return new Promise((resolve, reject) => {
            google.script.run
              .withSuccessHandler(res => {
                if(res.success) resolve(res);
                else reject(res.message);
              })
              .withFailureHandler(err => reject(err))
              .withdrawItem({ itemName: item.name, quantity: item.qty, receiver, handler, returnDate: mode === 'asset' ? returnDate : "" });
          });
        });

        await Promise.all(tasks);
        alert("ğŸ‰ é ˜ç”¨ç´€éŒ„å·²æˆåŠŸå…¨æ•¸å¯«å…¥ï¼Œç•«é¢å³å°‡é‡æ–°æ•´ç†ã€‚");
        // ğŸš€ é—œéµä¿®å¾©ï¼šå°å‘å›åˆ°é ˜ç”¨é é¢ï¼Œé˜²æ­¢ç©ºç™½
        google.script.run.withSuccessHandler(url => { window.top.location.href = url + "?page=withdraw"; }).getScriptUrl();
      } catch (e) {
        alert("âŒ å¯«å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ï¼š" + e.toString());
        btn.disabled = false; btn.innerText = "ç¢ºèªé€å‡ºç´€éŒ„";
      }
    }

    function resetView() { 
      document.getElementById('sanghaBox').style.display = (document.getElementById('mode').value === 'asset' ? 'none' : 'flex');
      cart = []; renderCart(); renderSelect(); 
    }

    loadData();
    google.script.run.withSuccessHandler(url => { document.getElementById('homeLink').href = url + "?page=index"; }).getScriptUrl();
  </script>
</body>
</html>
