<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æœ€è¿‘æè´ˆç´€éŒ„</title>
  <style>
    body { font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; padding: 20px; line-height: 1.6; background-color: #f4f7f6; color: #333; max-width: 800px; margin: auto; }
    h1 { color: #2c3e50; text-align: center; margin-bottom: 25px; }
    ul { list-style: none; padding: 0; }
    
    li { 
      background: white; margin-bottom: 15px; padding: 15px; 
      border-left: 5px solid #4CAF50; border-radius: 10px; 
      box-shadow: 0 4px 6px rgba(0,0,0,0.05); 
      display: flex; align-items: flex-start; gap: 15px;
      transition: 0.3s; position: relative;
    }
    
    /* ä¾›åƒ§ç‰©è³‡çš„ç‰¹æ®Šé‚Šæ¡†é¡è‰²ï¼ˆæ©˜è‰²ï¼‰ */
    li.sangha-item { border-left-color: #f59e0b; }
    li.out-of-stock { border-left-color: #94a3b8 !important; background-color: #f8fafc; opacity: 0.8; }
    
    .record-img { width: 80px; height: 80px; border-radius: 8px; object-fit: cover; border: 1px solid #eee; cursor: zoom-in; flex-shrink: 0; }
    .no-img { width: 80px; height: 80px; border-radius: 8px; background: #f1f5f9; color: #94a3b8; display: flex; align-items: center; justify-content: center; font-size: 24px; flex-shrink: 0; }

    .content-box { flex-grow: 1; }

    .skeleton { background: linear-gradient(110deg, #ececec 8%, #f5f5f5 18%, #ececec 33%); background-size: 200% 100%; animation: shine 1.5s linear infinite; height: 110px; border: none !important; margin-bottom: 15px; border-radius: 8px; }
    @keyframes shine { to { background-position-x: -200%; } }

    .cat-tag { background: #dcfce7; padding: 3px 10px; border-radius: 20px; font-size: 0.75em; color: #166534; margin-right: 8px; font-weight: bold; }
    
    /* ğŸš€ ä¾›åƒ§å°ˆç”¨æ¨™ç±¤æ¨£å¼ */
    .sangha-badge { background: #fef3c7; color: #92400e; padding: 3px 10px; border-radius: 20px; font-size: 0.75em; font-weight: bold; border: 1px solid #fde68a; margin-right: 8px; }

    .color-tag { color: #64748b; font-size: 0.9em; margin-left: 5px; background: #f1f5f9; padding: 1px 6px; border-radius: 4px; }
    .meta { color: #475569; font-size: 0.85em; margin-top: 4px; }
    .quantity-info { color: #0f172a; font-weight: bold; }
    
    .status-badge { position: absolute; bottom: 15px; right: 15px; font-size: 0.75em; padding: 4px 10px; border-radius: 6px; font-weight: bold; }
    .badge-none { background: #fee2e2; color: #b91c1c; }
    .badge-have { background: #f0fdf4; color: #15803d; border: 1px solid #bbf7d0; }

    #image-modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); align-items: center; justify-content: center; flex-direction: column; }
    #modal-img { max-width: 90%; max-height: 80%; border-radius: 8px; border: 4px solid white; }

    hr { border: 0; border-top: 1px solid #e2e8f0; margin: 30px 0; }
    #back-home { display: inline-block; text-decoration: none; color: #2563eb; font-weight: bold; padding: 10px 20px; border-radius: 6px; }
  </style>
</head>
<body>
  <h1>ğŸ“‹ æœ€è¿‘æè´ˆç´€éŒ„ï¼ˆ20 ç­†ï¼‰</h1>

  <ul id="list">
    <li class="skeleton"></li>
    <li class="skeleton"></li>
    <li class="skeleton"></li>
  </ul>

  <div id="image-modal" onclick="this.style.display='none'">
    <img id="modal-img" src="">
    <p style="color:white; margin-top:15px; font-size: 0.9em;">(é»æ“Šä»»ä½•è™•é—œé–‰)</p>
  </div>

  <hr/>
  <div style="text-align:center;">
    <a id="back-home" href="#">â¬…ï¸ å›åŠŸèƒ½é¦–é </a>
  </div>

  <script>
    function loadData() {
      const ul = document.getElementById('list');
      
      // ğŸš€ ç´€éŒ„é é¢æ°¸é å‚³å…¥ trueï¼Œé¡¯ç¤ºåŒ…å«ä¾›åƒ§åœ¨å…§çš„æ‰€æœ‰ç´€éŒ„
      google.script.run.withSuccessHandler(res => {
        if (!res || !res.success) {
          ul.innerHTML = `<li style="border-left-color: #ef4444; color: #b91c1c;">âŒ è¼‰å…¥å¤±æ•—</li>`;
          return;
        }

        ul.innerHTML = ''; 

        const stockMap = {};
        res.inventory.forEach(item => {
          const key = item.name + (item.color && item.color !== 'ç„¡' ? " (" + item.color + ")" : "");
          stockMap[key] = item.qty;
        });

        if (res.recent.length === 0) {
          ul.innerHTML = '<li style="text-align:center; border:none; color:#64748b;">ğŸ“­ ç›®å‰å°šç„¡ä»»ä½•æè´ˆç´€éŒ„</li>';
          return;
        }

        res.recent.forEach(d => {
          const li = document.createElement('li');
          // ğŸš€ åˆ¤æ–·æ˜¯å¦ç‚ºä¾›åƒ§ï¼Œç”¨æ–¼åŠ ä¸Šæ¨™ç±¤èˆ‡è®Šæ›´å·¦å´é‚Šæ¡†é¡è‰²
          const isSangha = (d.stockStatus === 'ä¾›åƒ§å°ˆç”¨' || d.stockStatus === 'ä¾›åƒ§');
          
          const colorSuffix = (d.color && d.color !== 'ç„¡') ? ` (${d.color})` : '';
          const itemKey = d.itemName + colorSuffix;
          const currentQty = stockMap[itemKey] !== undefined ? stockMap[itemKey] : 0;
          const isOut = currentQty <= 0;

          if (isOut) li.classList.add('out-of-stock');
          if (isSangha) li.classList.add('sangha-item');

          const imgHtml = d.photoUrl ? 
            `<img src="${d.photoUrl}" class="record-img" onclick="zoomImg('${d.photoUrl}')">` : 
            `<div class="no-img">${isSangha ? 'â˜¸ï¸' : 'ğŸ“¦'}</div>`;

          li.innerHTML = `
            ${imgHtml}
            <div class="content-box">
              <div class="status-badge ${isOut ? 'badge-none' : 'badge-have'}">
                ${isOut ? 'âœ“ å·²é ˜ç½„' : 'â— é¤˜é¡ï¼š' + currentQty + ' ' + d.unit}
              </div>
              <div>
                <span class="cat-tag">${d.category || 'æœªåˆ†é¡'}</span>
                ${isSangha ? '<span class="sangha-badge">â˜¸ï¸ ä¾›åƒ§</span>' : ''}
                <strong>${d.itemName}</strong>${d.color !== 'ç„¡' ? `<span class="color-tag">${d.color}</span>` : ''}
              </div>
              <div class="meta">å…¥åº«æ—¥æœŸï¼š${d.donationDate}</div>
              <div class="meta">ç•¶æ™‚å…¥åº«ï¼š<span class="quantity-info">${d.quantity} ${d.unit}</span></div>
              <div class="meta">ä¾†æºï¼š${d.donorName} | å­˜æ”¾ï¼š${d.location || 'æœªæ¨™è¨»'}</div>
            </div>
          `;
          ul.appendChild(li);
        });
      }).getSummaryData(true); 
    }

    function zoomImg(src) {
      const modal = document.getElementById('image-modal');
      const modalImg = document.getElementById('modal-img');
      modalImg.src = src;
      modal.style.display = 'flex';
    }

    loadData();

    google.script.run.withSuccessHandler(url => {
      const a = document.getElementById('back-home');
      a.href = url + "?page=index"; a.target = "_top";
    }).getScriptUrl();
  </script>
</body>
</html>
