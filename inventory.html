<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>åº«å­˜è³‡ç”¢æ™ºæ§ç¸½è¦½</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root { --primary: #3b82f6; --success: #10b981; --warning: #f59e0b; --danger: #ef4444; --gray: #64748b; --bg: #f8fafc; }
    body { font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; padding: 20px; background-color: var(--bg); color: #1e293b; margin: auto; max-width: 950px; line-height: 1.6; }
    h1 { color: #0f172a; text-align: center; font-size: 1.8rem; margin-bottom: 25px; font-weight: 800; }
    
    /* å„€è¡¨æ¿ */
    .dashboard { display: grid; grid-template-columns: 1.2fr 1fr; gap: 20px; margin-bottom: 25px; background: white; padding: 25px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
    .chart-box { height: 200px; position: relative; }

    /* ğŸš€ åŒ¯å‡ºæŒ‰éˆ•å€ */
    .export-container { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    .btn-export { flex: 1; min-width: 150px; padding: 12px; color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 14px; }
    .export-all { background: #64748b; }
    .export-asset { background: #3b82f6; }
    .export-inv { background: #10b981; }
    .btn-export:hover { transform: translateY(-2px); opacity: 0.9; }

    /* æœå°‹èˆ‡åˆ†é ç±¤ */
    .search-container { position: relative; margin-bottom: 20px; }
    .search-input { width: 100%; padding: 14px 14px 14px 45px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 15px; box-sizing: border-box; background: white; }
    .search-icon { position: absolute; left: 15px; top: 15px; color: var(--gray); font-size: 18px; }

    .tabs { display: flex; gap: 10px; margin-bottom: 0; padding: 0 10px; }
    .tab { padding: 12px 24px; cursor: pointer; font-weight: bold; color: var(--gray); border-radius: 12px 12px 0 0; transition: 0.3s; background: #e2e8f0; }
    .tab.active { color: white; background: var(--primary); }
    .tab-content { display: none; background: white; padding: 20px; border-radius: 0 0 16px 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); overflow-x: auto; }
    .tab-content.active { display: block; animation: fadeIn 0.3s ease; }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    table { width: 100%; border-collapse: collapse; font-size: 0.95rem; min-width: 700px; }
    th { text-align: left; background: #f8fafc; padding: 15px 10px; color: var(--gray); border-bottom: 2px solid #edf2f7; font-size: 0.8rem; }
    td { padding: 15px 10px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
    
    .item-img { width: 50px; height: 50px; border-radius: 10px; object-fit: cover; border: 1px solid #e2e8f0; cursor: zoom-in; }
    .status-badge { padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: bold; display: inline-block; }
    .status-in { background: #dcfce7; color: #166534; }
    .status-out { background: #fff7ed; color: #9a3412; }

    /* åˆ†é æŒ‰éˆ• */
    .pagination { display: flex; justify-content: center; gap: 15px; margin-top: 25px; align-items: center; }
    .page-btn { padding: 8px 16px; border: 1px solid #e2e8f0; background: white; border-radius: 8px; cursor: pointer; font-weight: bold; }
    .page-btn:disabled { opacity: 0.4; cursor: not-allowed; }

    #loading-overlay { text-align: center; padding: 80px 0; }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 45px; height: 45px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    #image-modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.9); align-items: center; justify-content: center; }
    #modal-img { max-width: 85%; max-height: 80%; border-radius: 16px; }
  </style>
</head>
<body>

  <div id="loading-overlay">
    <div class="spinner"></div>
    <p style="font-weight:bold; color:var(--gray);">æ­£åœ¨åŒæ­¥æœ€æ–°åº«å­˜æ•¸æ“š...</p>
  </div>

  <div id="main-ui" style="display:none;">
    <h1>ğŸ“Š åº«å­˜è³‡ç”¢æ™ºæ§ç¸½è¦½</h1>

    <div class="dashboard">
      <div>
        <h4 style="margin:0 0 15px 0; font-size: 0.95rem; color: var(--gray);">ğŸ› ï¸ è³‡ç”¢ç¾ç‹€åˆ†ä½ˆ</h4>
        <div class="chart-box"><canvas id="inventoryChart"></canvas></div>
      </div>
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
        <div style="background:#eff6ff; padding:18px; border-radius:12px; border-left: 5px solid var(--primary);">
          <small style="color:var(--primary); font-weight:bold;">è³‡ç”¢åœ¨åº«</small><br><strong id="asset-in-count" style="font-size:1.6rem">0</strong>
        </div>
        <div style="background:#fff7ed; padding:18px; border-radius:12px; border-left: 5px solid var(--warning);">
          <small style="color:#9a3412; font-weight:bold;">å€Ÿå‡º/ç¶­ä¿®</small><br><strong id="asset-out-count" style="color:#ea580c; font-size:1.6rem">0</strong>
        </div>
        <div style="background:#fee2e2; padding:18px; border-radius:12px; border-left: 5px solid var(--danger); grid-column: span 2;">
          <small style="color:var(--danger); font-weight:bold;">ç´¯è¨ˆæè€— (å ±å»¢/éºå¤±)</small><br><strong id="asset-scrap-count" style="color:var(--danger); font-size:1.3rem">0</strong>
        </div>
      </div>
    </div>

    <div class="export-container">
      <button class="btn-export export-asset" onclick="exportReport('asset')">ğŸ“¥ åŒ¯å‡ºå›ºå®šè³‡ç”¢</button>
      <button class="btn-export export-inv" onclick="exportReport('inventory')">ğŸ“¥ åŒ¯å‡ºæ¶ˆè€—å“</button>
      <button class="btn-export export-all" onclick="exportReport('all')">ğŸ“¥ åŒ¯å‡ºå®Œæ•´å ±è¡¨</button>
    </div>

    <div class="search-container">
      <span class="search-icon">ğŸ”</span>
      <input type="text" id="globalSearch" class="search-input" placeholder="æœå°‹å“åã€ç·¨è™Ÿã€ä¿ç®¡äººæˆ–å­˜æ”¾ä½ç½®..." oninput="resetPager(); processData()">
    </div>

    <div class="tabs">
      <div class="tab active" onclick="switchTab(this, 'consumable')">æ¶ˆè€—å“ (è‡ªå‹•å½™æ•´)</div>
      <div class="tab" onclick="switchTab(this, 'asset')">å›ºå®šè³‡ç”¢ (ç¨ç«‹ç·¨è™Ÿ)</div>
    </div>

    <div id="consumable-content" class="tab-content active">
      <div id="inv-container"></div>
      <div class="pagination" id="invPager"></div>
    </div>

    <div id="asset-content" class="tab-content">
      <table>
        <thead>
          <tr><th>ç…§ç‰‡</th><th>ç·¨è™Ÿ</th><th>å“åè¦æ ¼</th><th>å­˜æ”¾ä½ç½®</th><th>ä¿ç®¡äºº</th><th>ç‹€æ…‹</th></tr>
        </thead>
        <tbody id="assetBody"></tbody>
      </table>
      <div class="pagination" id="assetPager"></div>
    </div>
  </div>

  <div id="image-modal" onclick="this.style.display='none'">
    <img id="modal-img" src="">
  </div>

  <div style="text-align:center; margin-top:35px; padding-bottom:40px;">
    <a id="home" href="#" style="text-decoration:none; color:var(--gray); font-weight:bold; border-bottom: 2px solid #e2e8f0; padding-bottom:4px;">â¬…ï¸ è¿”å›åŠŸèƒ½é¸å–®</a>
  </div>

  <script>
    let rawInventory = [];
    let rawAssetsFull = []; 
    let myChart = null;
    let invPage = 1, assetPage = 1;
    const invPageSize = 8, assetPageSize = 12;

    function resetPager() { invPage = 1; assetPage = 1; }

    function loadData() {
      google.script.run.withSuccessHandler(res => {
        if (!res || !res.success) { alert("è¼‰å…¥å¤±æ•—"); return; }
        rawInventory = res.inventory;
        google.script.run.withSuccessHandler(assetList => {
          rawAssetsFull = assetList;
          document.getElementById('loading-overlay').style.display = 'none';
          document.getElementById('main-ui').style.display = 'block';
          updateSummaryCounts();
          processData();
        }).getAvailableAssetsFull();
      }).getSummaryData();
    }

    function processData() {
      const key = document.getElementById('globalSearch').value.toLowerCase();
      
      // éæ¿¾æ•¸æ“š
      const filteredInv = rawInventory.filter(i => i.name.toLowerCase().includes(key) || (i.category || "").toLowerCase().includes(key));
      const filteredAssets = rawAssetsFull.filter(a => a.name.toLowerCase().includes(key) || a.id.toLowerCase().includes(key) || (a.keeper || "").toLowerCase().includes(key));

      renderInventoryAggregated(filteredInv);
      renderAssetsPaginated(filteredAssets);
    }

    // ğŸš€ æ¶ˆè€—å“åˆ†é æ¸²æŸ“
    function renderInventoryAggregated(data) {
      const container = document.getElementById('inv-container');
      const pager = document.getElementById('invPager');
      container.innerHTML = "";

      // 1. å½™æ•´é‚è¼¯
      const aggregated = data.reduce((acc, curr) => {
        const itemKey = `${curr.name}|${curr.color}`;
        if (!acc[itemKey]) { acc[itemKey] = { ...curr, locations: new Set([curr.location]) }; }
        else { acc[itemKey].qty += curr.qty; if (curr.location) acc[itemKey].locations.add(curr.location); }
        return acc;
      }, {});
      const items = Object.values(aggregated);

      // 2. åˆ†é é‚è¼¯
      const start = (invPage - 1) * invPageSize;
      const pagedData = items.slice(start, start + invPageSize);

      container.innerHTML = `
        <table style="background:white; border-radius:12px; overflow:hidden;">
          <tr style="background:#fafafa;"><th>ç…§ç‰‡</th><th>å“åè¦æ ¼</th><th>å­˜æ”¾ä½ç½®</th><th style="text-align:right;">åœ¨åº«ç¸½é‡</th></tr>
          ${pagedData.map(i => `
            <tr>
              <td>${i.photoUrl ? `<img src="${i.photoUrl}" class="item-img" onclick="zoomImg(this.src, event)">` : `<div style="width:50px; height:50px; background:#f1f5f9; border-radius:10px; display:flex; align-items:center; justify-content:center; color:#cbd5e0;">ğŸ“¦</div>`}</td>
              <td><b>${i.name}</b><br><small>${i.color !== 'ç„¡' ? i.color : ''}</small></td>
              <td><small style="color:var(--primary); font-weight:600;">ğŸ“ ${Array.from(i.locations).filter(l => l).join(', ') || 'åº«æˆ¿'}</small></td>
              <td align="right"><b>${i.qty}</b> ${i.unit}</td>
            </tr>
          `).join('')}
        </table>
      `;

      const totalPages = Math.ceil(items.length / invPageSize);
      pager.innerHTML = `<button class="page-btn" ${invPage === 1 ? 'disabled' : ''} onclick="invPage--; processData()">ä¸Šé </button><b>${invPage} / ${totalPages || 1}</b><button class="page-btn" ${invPage === totalPages || totalPages === 0 ? 'disabled' : ''} onclick="invPage++; processData()">ä¸‹é </button>`;
    }

    // ğŸš€ å›ºå®šè³‡ç”¢åˆ†é æ¸²æŸ“
    function renderAssetsPaginated(data) {
      const tbody = document.getElementById('assetBody');
      const pager = document.getElementById('assetPager');
      const start = (assetPage - 1) * assetPageSize;
      const pageData = data.slice(start, start + assetPageSize);

      tbody.innerHTML = pageData.map(a => {
        let sc = (a.status === "å€Ÿå‡ºä¸­") ? "status-out" : "status-in";
        return `<tr><td>${a.photoUrl ? `<img src="${a.photoUrl}" class="item-img" onclick="zoomImg(this.src, event)">` : `ğŸ› ï¸`}</td><td><code>${a.id}</code></td><td><b>${a.name}</b></td><td>${a.location || 'åº«æˆ¿'}</td><td>${a.keeper || 'åº«æˆ¿'}</td><td><span class="status-badge ${sc}">${a.status}</span></td></tr>`;
      }).join('');

      const totalPages = Math.ceil(data.length / assetPageSize);
      pager.innerHTML = `<button class="page-btn" ${assetPage === 1 ? 'disabled' : ''} onclick="assetPage--; processData()">ä¸Šé </button><b>${assetPage} / ${totalPages || 1}</b><button class="page-btn" ${assetPage === totalPages || totalPages === 0 ? 'disabled' : ''} onclick="assetPage++; processData()">ä¸‹é </button>`;
    }

    function updateSummaryCounts() {
      const inS = rawAssetsFull.filter(a => a.status === 'åœ¨åº«').length;
      const out = rawAssetsFull.filter(a => a.status === 'å€Ÿå‡ºä¸­').length;
      const scrap = rawAssetsFull.filter(a => a.status === 'æ¯€æå ±å»¢').length;
      const lost = rawAssetsFull.filter(a => a.status === 'éºå¤±æ‰£é™¤').length;
      const rep = rawAssetsFull.filter(a => a.status === 'å¾…ç¶­ä¿®').length;
      document.getElementById('asset-in-count').textContent = inS;
      document.getElementById('asset-out-count').textContent = (out + rep);
      document.getElementById('asset-scrap-count').textContent = (scrap + lost);
      const ctx = document.getElementById('inventoryChart').getContext('2d');
      if (myChart) myChart.destroy();
      myChart = new Chart(ctx, { type: 'doughnut', data: { labels: ['åœ¨åº«', 'å€Ÿå‡º', 'æ¯€æ', 'éºå¤±', 'å¾…ä¿®'], datasets: [{ data: [inS, out, scrap, lost, rep], backgroundColor: ['#10b981', '#f59e0b', '#ef4444', '#94a3b8', '#3b82f6'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '80%', plugins: { legend: { display: false } } } });
    }

    function exportReport(type) {
      google.script.run.withSuccessHandler(htmlContent => {
        const win = window.open("", "_blank");
        win.document.write(htmlContent);
        win.document.close();
      }).exportInventoryToHtml(type);
    }

    function zoomImg(src, event) { event.stopPropagation(); document.getElementById('modal-img').src = src; document.getElementById('image-modal').style.display = 'flex'; }
    function switchTab(el, type) { document.querySelectorAll('.tab').forEach(t => t.classList.remove('active')); document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active')); el.classList.add('active'); document.getElementById(type + '-content').classList.add('active'); }
    loadData();
    google.script.run.withSuccessHandler(url => { document.getElementById('home').href = url + "?page=index"; }).getScriptUrl();
  </script>
</body>
</html>
