<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>å¯¦ç‰©æè´ˆ/å…¥åº«ç™»å…¥</title>
  <style>
    body { 
      font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; 
      padding: 20px; margin: auto; line-height: 1.6; 
      background-color: #f0f2f5; color: #333;
    }
    
    h1 { color: #2c3e50; text-align: center; margin-bottom: 25px; font-weight: 800; }
    
    #donation-form { 
      background: white; padding: 30px; border-radius: 16px; 
      box-shadow: 0 4px 20px rgba(0,0,0,0.08); max-width: 850px; 
      margin: auto;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px 25px;
    }

    /* æ‰‹æ©Ÿç‰ˆè‡ªå‹•åˆ‡æ›å–®æ¬„ */
    @media (max-width: 600px) {
      #donation-form { grid-template-columns: 1fr; }
      h1, .full-width, button, .photo-area, .grid-span-2 { grid-column: span 1 !important; }
    }

    h1, .grid-span-2, button, .photo-area { grid-column: span 2; }

    label { display: block; font-weight: bold; color: #4a5568; font-size: 0.9em; margin-bottom: 5px; }
    
    input, select { 
      width: 100%; padding: 12px; box-sizing: border-box; 
      border: 1px solid #cbd5e0; border-radius: 8px; font-size: 16px; 
      transition: all 0.2s;
    }
    
    input:focus, select:focus { border-color: #4CAF50; box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1); outline: none; }

    .hint { font-size: 0.85em; color: #718096; background: #f7fafc; padding: 10px; border-radius: 6px; border-left: 4px solid #4CAF50; }

    .photo-area { 
      background: #fafafa; padding: 20px; border-radius: 12px; 
      border: 2px dashed #cbd5e0; text-align: center; margin: 10px 0;
    }

    #previewImg { 
      max-width: 150px; border-radius: 10px; 
      margin-top: 15px; display: none; border: 3px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    button { 
      padding: 18px; background: #4CAF50; color: white; border: none; 
      cursor: pointer; font-size: 18px; border-radius: 10px; font-weight: bold; 
      margin-top: 15px; transition: 0.3s;
    }
    
    button:hover { background: #45a049; transform: translateY(-1px); }
    button:disabled { background: #cbd5e0; transform: none; }

    .loader {
      border: 3px solid #f3f3f3; border-top: 3px solid white; border-radius: 50%;
      width: 18px; height: 18px; animation: spin 1s linear infinite;
      display: inline-block; vertical-align: middle; margin-right: 8px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    #msg { margin-top: 25px; text-align: center; padding: 15px; border-radius: 10px; font-weight: bold; display: none; }

    nav { 
      text-align: center; padding: 25px; background: white; 
      border-radius: 16px; max-width: 850px; margin: 30px auto;
      display: flex; flex-wrap: wrap; justify-content: center; gap: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    nav a { text-decoration: none; color: #2196F3; font-weight: 600; padding: 10px 16px; background: #f0f7ff; border-radius: 8px; font-size: 0.9em; transition: 0.2s; }
    nav a:hover { background: #2196F3; color: white; }

  </style>
</head>
<body>
  <h1>ğŸ å¯¦ç‰©æè´ˆå…¥åº«</h1>
  
  <form id="donation-form">
    <div class="grid-item">
      <label>ğŸ“… æè´ˆæ—¥æœŸï¼š</label>
      <input type="date" id="dDate" name="donationDate" required>
    </div>
    
    <div class="grid-item">
      <label>ğŸ‘¤ ä¾†æº/æè´ˆè€…ï¼š</label>
      <input type="text" name="donorName" required placeholder="å¦‚ï¼šå‚…æ„‰ã€æŸæŸå…¬å¸">
    </div>
    
    <div class="grid-item">
      <label>ğŸ“¦ ç‰©å“åç¨±ï¼š</label>
      <input type="text" name="itemName" id="itemName" required placeholder="å¦‚ï¼šå·§å…‹åŠ›æ¢ã€è±†è…">
    </div>
    
    <div class="grid-item">
      <label>ğŸ¨ é¡è‰²/è¦æ ¼ï¼š</label>
      <input type="text" name="color" placeholder="å¦‚ï¼šç„¡ã€è—è‰²ã€å¤§åŒ…è£">
    </div>

    <div class="grid-item">
      <label>ğŸ”’ åº«å­˜å±¬æ€§ï¼š</label>
      <select name="itemStatus" id="itemStatus">
        <option value="å¯ç”¨">âœ… ä¸€èˆ¬ç‰©è³‡ (å¯æ­£å¸¸é ˜ç”¨)</option>
        <option value="ä¾›åƒ§">â˜¸ï¸ ä¾›åƒ§ (é è¨­å‡çµä¸é¡¯ç¤º)</option>
      </select>
    </div>

    <div class="grid-item">
      <label>âš–ï¸ å–®ä½ï¼š</label>
      <input type="text" name="unit" placeholder="å¦‚ï¼šç®±ã€ç›’ã€æœ¬">
    </div>
    
    <div class="grid-item">
      <label>ğŸ”¢ å…¥æ•¸ (å–®ä¸€åŒ…è£å…§å«æ•¸é‡)ï¼š</label>
      <input type="number" name="unitRatio" value="1" min="1" required>
    </div>

    <div class="grid-item">
      <label>â• å…¥åº«ç¸½æ•¸é‡ (å–®ä½æ•¸)ï¼š</label>
      <input type="number" name="quantity" min="1" required placeholder="è«‹è¼¸å…¥å…¥åº«å¹¾ç®±/å¹¾ç›’">
    </div>

    <div class="grid-span-2">
      <div class="hint">ğŸ’¡ è¦æ ¼åŒ–èªªæ˜ï¼šè‹¥ 1 ç®±æœ‰ 12 ç›’è±†è…ï¼Œå–®ä½å¡«ã€Œç®±ã€ï¼Œå…¥æ•¸å¡«ã€Œ12ã€ï¼Œå…¥åº«æ•¸é‡å¡«ã€Œ1ã€ã€‚ç³»çµ±æœƒè‡ªå‹•ç®—ç‚º 12 å€‹ã€‚</div>
    </div>

    <div class="grid-item">
      <label>ğŸ“ å­˜æ”¾ä½ç½®ï¼š</label>
      <input type="text" name="location" placeholder="å¦‚ï¼šåº«æˆ¿ B1ã€èŒ¶æ°´é–“">
    </div>
    
    <div class="grid-item">
      <label>âœï¸ ç¶“æ‰‹äººï¼š</label>
      <input type="text" name="handler" required placeholder="æ‚¨çš„å§“å">
    </div>
    
    <div class="grid-item full-width" style="grid-column: span 2;">
      <label>âŒ› æœ‰æ•ˆæœŸé™ï¼š</label>
      <input type="date" name="expiryDate">
    </div>

    <div class="photo-area">
      <label style="color:#4a5568;">ğŸ“¸ ç‰©å“ç…§ç‰‡ (æ‹ç…§å³æ™‚é è¦½)</label>
      <input type="file" id="cameraInput" accept="image/*" capture="environment" style="margin-top:10px; border:none; padding:0;">
      <div id="photoStatus" style="font-size: 0.8em; color: #a0aec0; margin-top: 10px;">æœªä¸Šå‚³ç…§ç‰‡</div>
      <img id="previewImg" src="">
      <input type="hidden" name="photoUrl" id="hiddenPhotoUrl">
    </div>

    <div class="grid-span-2">
      <label>ğŸ“ å‚™è¨»äº‹é …ï¼š</label>
      <input type="text" name="note" placeholder="å¦‚ï¼šä¸­å°ç”³è«‹ç”¨ã€æ³•æœƒé å‚™">
    </div>

    <button type="submit" id="submit-btn">ç¢ºèªé€å‡ºå…¥åº«</button>
  </form>

  <div id="msg"></div>

  <nav id="nav-links">
    <span style="color:#94a3b8; font-size: 0.8em;">å°è¦½é¸å–®è¼‰å…¥ä¸­...</span>
  </nav>

  <script>
    const form = document.getElementById('donation-form');
    const btn = document.getElementById('submit-btn');
    const msg = document.getElementById('msg');
    const cameraInput = document.getElementById('cameraInput');
    const previewImg = document.getElementById('previewImg');
    const hiddenPhotoUrl = document.getElementById('hiddenPhotoUrl');
    const photoStatus = document.getElementById('photoStatus');

    document.getElementById('dDate').valueAsDate = new Date();

    cameraInput.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) {
        hiddenPhotoUrl.value = "";
        previewImg.style.display = 'none';
        photoStatus.textContent = "æœªä¸Šå‚³ç…§ç‰‡";
        return;
      }

      photoStatus.innerHTML = '<div class="loader" style="border-top-color:#718096"></div> ç¸®åœ–æœ€ä½³åŒ–ä¸­...';
      const reader = new FileReader();
      reader.onload = function(event) {
        const img = new Image();
        img.onload = function() {
          const canvas = document.createElement('canvas');
          const max_size = 150; 
          let width = img.width, height = img.height;

          if (width > height) { if (width > max_size) { height *= max_size / width; width = max_size; } }
          else { if (height > max_size) { width *= max_size / height; height = max_size; } }
          
          canvas.width = width;
          canvas.height = height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);

          const dataUrl = canvas.toDataURL('image/jpeg', 0.6); 
          previewImg.src = dataUrl;
          previewImg.style.display = 'inline-block';
          hiddenPhotoUrl.value = dataUrl;
          photoStatus.innerHTML = "âœ… ç…§ç‰‡å·²å°±ç·’";
        };
        img.src = event.target.result;
      };
      reader.readAsDataURL(file);
    });

    form.addEventListener('submit', function(e) {
      e.preventDefault();
      btn.disabled = true;
      btn.innerHTML = '<div class="loader"></div> æ­£åœ¨åŒæ­¥é›²ç«¯...';
      msg.style.display = "block";
      msg.style.background = "#ebf8ff";
      msg.style.color = "#2b6cb0";
      msg.innerHTML = 'â³ è«‹ç¨å€™ï¼Œæ­£åœ¨é€²è¡Œè‡ªå‹•åˆ†é¡èˆ‡è³‡æ–™å­˜æª”...';
      
      const formData = Object.fromEntries(new FormData(this));

      google.script.run
        .withSuccessHandler(res => {
          btn.disabled = false;
          btn.textContent = "ç¢ºèªé€å‡ºå…¥åº«";
          if(res.success) {
            msg.style.background = "#f0fff4";
            msg.style.color = "#2f855a";
            msg.innerHTML = `âœ… å…¥åº«æˆåŠŸï¼ç³»çµ±å·²å°‡å…¶åˆ†é¡ç‚ºï¼š<strong>${res.category}</strong>`;
            
            // ä¿ç•™å›ºå®šæ¬„ä½
            const h = formData.handler, d = formData.donorName, l = formData.location;
            form.reset();
            document.getElementById('dDate').valueAsDate = new Date();
            form.handler.value = h;
            form.donorName.value = d;
            form.location.value = l;
            previewImg.style.display = 'none';
            hiddenPhotoUrl.value = "";
            photoStatus.textContent = "æœªä¸Šå‚³ç…§ç‰‡";
            form.itemName.focus();
          } else {
            msg.style.background = "#fff5f5";
            msg.style.color = "#c53030";
            msg.innerHTML = "âŒ å¤±æ•—ï¼š" + res.message;
          }
        })
        .addDonation(formData);
    });

    google.script.run.withSuccessHandler(url => {
      document.getElementById('nav-links').innerHTML = `
        <a href="${url}?page=recent" target="_top">æœ€è¿‘ç´€éŒ„</a>
        <a href="${url}?page=near-expiry" target="_top">å³æœŸå“</a>
        <a href="${url}?page=withdraw" target="_top" style="color:#ef4444">ğŸ“¤ é ˜ç”¨/å€Ÿå‡º</a>
        <a href="${url}?page=asset_return" target="_top" style="color:#f59e0b">ğŸ”™ è³‡ç”¢æ­¸é‚„</a>
        <a href="${url}?page=asset_entry" target="_top" style="color:#3b82f6">ğŸ› ï¸ è³‡ç”¢å»ºæª”</a>
        <a href="${url}?page=inventory" target="_top">ğŸ“Š æ™ºæ§ç¸½è¦½</a>
      `;
    }).getScriptUrl();
  </script>
</body>
</html>
